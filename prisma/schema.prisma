generator client {
  provider = "prisma-client"
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          Int                           @id @default(autoincrement())
  supabase_uid                String                        @unique
  display_name                String?
  xp                          Int                           @default(0)
  level                       Int                           @default(1)
  credits                     Int                           @default(0)
  steamId                     String?
  epicConnect                 Boolean?                      @default(false)
  gogConnect                  Boolean?                      @default(false)
  receivedMessages            Message[]                     @relation("ReceivedMessages")
  sentMessages                Message[]                     @relation("SentMessages")
  userGames                   UserGame[]
  wishlist_deal_notifications wishlist_deal_notifications[]
  wishlistItems               Wishlist[]

  @@map("users")
}

model Game {
  id                          Int                           @id @default(autoincrement())
  igdbId                      Int?                          @unique
  name                        String
  slug                        String?
  summary                     String?
  storyline                   String?
  firstReleaseDate            DateTime?
  coverUrl                    String?
  screenshots                 String[]
  totalRating                 Float?
  genres                      String[]
  developers                  String[]
  publishers                  String[]
  websites                    Json?
  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  lastSyncedAt                DateTime?
  videos                      String[]                      @default([])
  deals                       Deal[]
  userGames                   UserGame[]
  wishlist_deal_notifications wishlist_deal_notifications[]
  wishlistedBy                Wishlist[]

  @@map("games")
}

model Platform {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  slug    String  @unique
  iconUrl String?
  siteUrl String?

  @@map("platforms")
}

model UserGame {
  id              Int       @id @default(autoincrement())
  userId          Int
  gameId          Int
  addedAt         DateTime  @default(now())
  playtimeMinutes Int?      @default(0)
  lastPlayed      DateTime?
  isInstalled     Boolean   @default(false)
  isFavorite      Boolean   @default(false)
  notes           String?
  platformDRMs    Int[]     @default([])
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "user_games_userid_gameid_unique")
  @@map("user_games")
}

model Deal {
  id                          Int                           @id @default(autoincrement())
  gameId                      Int?
  title                       String
  storeName                   String
  price                       Float?
  discountPercent             Float?
  originalPrice               Float?
  url                         String
  validFrom                   DateTime?
  validUntil                  DateTime?
  isFreebie                   Boolean                       @default(false)
  discoveredAt                DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  externalId                  String?
  source                      String?
  thumb                       String?
  rating                      Float?
  game                        Game?                         @relation(fields: [gameId], references: [id], onDelete: Cascade)
  wishlist_deal_notifications wishlist_deal_notifications[]

  @@unique([externalId, source], name: "deal_external_unique")
  @@map("deals")
}

model Wishlist {
  id      Int      @id @default(autoincrement())
  userId  Int
  gameId  Int
  addedAt DateTime @default(now())
  game    Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "wishlist_items_userid_gameid_unique")
  @@map("wishlist_items")
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int?
  receiverId Int
  text       String
  media      String?
  createdAt  DateTime @default(now())
  isRead     Boolean  @default(false)
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender     User?    @relation("SentMessages", fields: [senderId], references: [id])

  @@map("messages")
}

model wishlist_deal_notifications {
  id               Int      @id @default(autoincrement())
  userId           Int
  gameId           Int
  dealId           Int
  notificationSent Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  deals            Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  games            Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  users            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dealId])
}
