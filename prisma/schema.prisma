generator client {
  provider = "prisma-client-js"
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  supabase_uid     String            @unique
  display_name     String?
  xp               Int               @default(0)
  level            Int               @default(1)
  credits          Int               @default(0)
  steamId          String?    
  epicConnect      Boolean?          @default(false)   
  gogConnect       Boolean?          @default(false) 
  userGames        UserGame[]
  wishlistItems    Wishlist[]
  sentMessages     Message[]         @relation("SentMessages")
  receivedMessages Message[]         @relation("ReceivedMessages")

  @@map("users")
}

model Game {
  id                    Int            @id @default(autoincrement())
  igdbId                Int?           @unique
  name                  String
  slug                  String?        
  summary               String?
  storyline             String?
  firstReleaseDate      DateTime?
  coverUrl              String?
  screenshots           String[]
  videos                String[]       @default([])
  totalRating           Float?
  genres                String[]
  developers            String[]
  publishers            String[]
  websites              Json?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  lastSyncedAt          DateTime?
  deals                 Deal[]
  userGames             UserGame[]
  wishlistedBy          Wishlist[]

  @@map("games")
}

model Platform {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  slug          String         @unique
  iconUrl       String?
  siteUrl       String?

  @@map("platforms")
}

model UserGame {
  id              Int       @id @default(autoincrement())
  userId          Int
  gameId          Int
  platformDRMs    Int[]     @default([]) // IDs of platforms where the game is bought from
  addedAt         DateTime  @default(now())
  playtimeMinutes Int?      @default(0)
  lastPlayed      DateTime?
  isInstalled     Boolean   @default(false)
  isFavorite      Boolean   @default(false)
  notes           String?
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "user_games_userid_gameid_unique")
  @@map("user_games")
}

model Deal {
  id              Int      @id @default(autoincrement())
  gameId          Int?
  title           String
  storeName       String
  price           Float?
  discountPercent Float?
  originalPrice   Float?
  url             String
  validFrom       DateTime?
  validUntil      DateTime?
  isFreebie       Boolean  @default(false)
  discoveredAt    DateTime @default(now())
  updatedAt       DateTime @updatedAt
  externalId      String?
  source          String?
  thumb           String?   // Thumbnail URL from API
  rating          Float?    // Deal Rating from CheapShark API (0.0 - 10.0)
  game            Game?    @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("deals")
}

model Wishlist {
  id      Int      @id @default(autoincrement())
  userId  Int
  gameId  Int
  addedAt DateTime @default(now())
  game    Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "wishlist_items_userid_gameid_unique")
  @@map("wishlist_items")
}

model Message {
  id          Int      @id @default(autoincrement())
  senderId    Int?
  receiverId  Int
  text        String
  media       String?
  createdAt   DateTime @default(now())
  isRead      Boolean  @default(false)
  sender      User?    @relation("SentMessages", fields: [senderId], references: [id], onDelete: SetNull)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}
