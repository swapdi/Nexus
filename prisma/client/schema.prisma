generator client {
  provider = "prisma-client-js"
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  supabase_uid     String            @unique
  display_name     String?
  xp               Int               @default(0)
  level            Int               @default(1)
  credits          Int               @default(0)
  userAchievements UserAchievement[]
  userGames        UserGame[]
  wishlistItems    Wishlist[]

  @@map("users")
}

model Game {
  id            Int            @id @default(autoincrement())
  title         String
  description   String?
  coverUrl      String?
  releaseDate   DateTime?
  developer     String?
  publisher     String?
  genres        String[]
  rating        Float? // IGDB Global Rating (1-10 mit Dezimalstellen)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deals         Deal[]
  platformGames PlatformGame[]
  userGames     UserGame[]
  wishlistedBy  Wishlist[]

  @@map("games")
}

model Platform {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  slug          String         @unique
  iconUrl       String?
  siteUrl       String?
  platformGames PlatformGame[]

  @@map("platforms")
}

model PlatformGame {
  id                 Int      @id @default(autoincrement())
  gameId             Int
  platformId         Int
  platformSpecificId String
  url                String?
  deals              Deal[]
  game               Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platform           Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@unique([gameId, platformId])
  @@unique([platformId, platformSpecificId])
  @@unique([gameId, platformId], map: "platform_games_gameid_platformid_unique")
  @@unique([platformId, platformSpecificId], map: "platform_games_platformid_platformspecificid_unique")
  @@map("platform_games")
}

model UserGame {
  id              Int       @id @default(autoincrement())
  userId          Int
  gameId          Int
  addedAt         DateTime  @default(now())
  playtimeMinutes Int?      @default(0)
  lastPlayed      DateTime?
  isInstalled     Boolean   @default(false)
  isFavorite      Boolean   @default(false)
  notes           String?
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "user_games_userid_gameid_unique")
  @@map("user_games")
}

model Deal {
  id              Int           @id @default(autoincrement())
  gameId          Int
  platformGameId  Int?
  title           String
  storeName       String
  price           Float?
  discountPercent Float?
  originalPrice   Float?
  url             String
  validFrom       DateTime?
  validUntil      DateTime?
  isFreebie       Boolean       @default(false)
  discoveredAt    DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  game            Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platformGame    PlatformGame? @relation(fields: [platformGameId], references: [id])

  @@map("deals")
}

model Achievement {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  description      String
  iconUrl          String?
  criteria         String
  xpReward         Int               @default(0)
  creditsReward    Int               @default(0)
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@unique([userId, achievementId], map: "user_achievements_userid_achievementid_unique")
  @@map("user_achievements")
}

model Wishlist {
  id      Int      @id @default(autoincrement())
  userId  Int
  gameId  Int
  addedAt DateTime @default(now())
  game    Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "wishlist_items_userid_gameid_unique")
  @@map("wishlist_items")
}
