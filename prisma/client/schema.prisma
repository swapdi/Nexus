generator client {
  provider = "prisma-client-js"
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int      @id @default(autoincrement())
  supabase_uid String   @unique // Sicherstellen, dass dies eindeutig ist
  email        String   @unique // Sicherstellen, dass dies eindeutig ist
  display_name String?
  account      Account? @relation("UserAccount")
  xp           Int      @default(0)
  level        Int      @default(1)
  credits      Int      @default(0)

  userGames        UserGame[]
  userAchievements UserAchievement[]
  wishlistItems    Wishlist[]

  @@map("users")
}

model Account {
  id                  Int      @id @default(autoincrement())
  name                String
  current_period_ends DateTime @default(now())
  features            String[]
  user_id             Int      @unique
  user                User     @relation(fields: [user_id], references: [id], name: "UserAccount", onDelete: Cascade) // onDelete hinzugefügt

  @@map("account")
}

model Game {
  id          Int       @id @default(autoincrement())
  title       String
  description String?   @db.Text
  coverUrl    String?
  releaseDate DateTime?
  developer   String?
  publisher   String?
  genres      String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  userGames     UserGame[]
  platformGames PlatformGame[]
  wishlistedBy  Wishlist[]
  deals         Deal[]

  @@map("games")
}

model Platform {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  slug    String  @unique // z.B. "steam", "gog", "epic"
  iconUrl String?
  siteUrl String?

  platformGames PlatformGame[]

  @@map("platforms")
}

// Verknüpfungstabelle für Game und Platform, um plattformspezifische IDs zu speichern
model PlatformGame {
  id                 Int     @id @default(autoincrement())
  gameId             Int
  platformId         Int
  platformSpecificId String // z.B. Steam AppID, Epic ID
  url                String? // Direkter Link zum Spiel auf der Plattform

  game     Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  deals    Deal[] // Deals, die spezifisch für diese Plattformversion sind

  @@unique([gameId, platformId])
  @@unique([platformId, platformSpecificId]) // Jede platformSpecificId sollte pro Plattform eindeutig sein
  @@map("platform_games")
}

model UserGame {
  id              Int       @id @default(autoincrement())
  userId          Int
  gameId          Int
  addedAt         DateTime  @default(now())
  playtimeMinutes Int?      @default(0)
  lastPlayed      DateTime?
  isInstalled     Boolean   @default(false)
  notes           String?   @db.Text
  rating          Int? // Persönliche Bewertung 0-100 oder 1-5 etc.

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@map("user_games")
}

model Deal {
  id              Int       @id @default(autoincrement())
  gameId          Int // Allgemeiner Link zum Spiel, falls nicht plattformspezifisch
  platformGameId  Int? // Optional: Link zu einer spezifischen Plattformversion des Spiels
  title           String // Kann vom Spieltitel abweichen (z.B. "XYZ Deluxe Edition")
  storeName       String // z.B. "Steam Store", "Humble Bundle", "GOG"
  price           Float?
  discountPercent Float?
  originalPrice   Float?
  url             String    @db.Text
  validFrom       DateTime?
  validUntil      DateTime?
  isFreebie       Boolean   @default(false)
  discoveredAt    DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  game         Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platformGame PlatformGame? @relation(fields: [platformGameId], references: [id], onDelete: SetNull) // SetNull, falls Plattformversion gelöscht wird, Deal aber bestehen bleiben soll

  @@map("deals")
}

model Achievement {
  id            Int      @id @default(autoincrement())
  name          String   @unique
  description   String   @db.Text
  iconUrl       String?
  criteria      String   @db.Text // Beschreibung der Kriterien
  xpReward      Int      @default(0)
  creditsReward Int      @default(0)
  createdAt     DateTime @default(now())

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            Int      @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Wishlist {
  id      Int      @id @default(autoincrement())
  userId  Int
  gameId  Int
  addedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@map("wishlist_items")
}
