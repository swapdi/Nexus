generator client {
  provider = "prisma-client-js"
  output   = "./client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  supabase_uid     String            @unique
  display_name     String?
  xp               Int               @default(0)
  level            Int               @default(1)
  credits          Int               @default(0)
  userAchievements UserAchievement[]
  userGames        UserGame[]
  wishlistItems    Wishlist[]

  @@map("users")
}

model Game {
  id Int @id @default(autoincrement())

  // IGDB Core Fields
  igdbId           Int?      @unique // IGDB Game ID
  name             String // IGDB: name
  slug             String?   @unique // IGDB: slug
  summary          String? // IGDB: summary
  storyline        String? // IGDB: storyline
  firstReleaseDate DateTime? // IGDB: first_release_date

  // Visual Assets
  coverUrl    String? // IGDB: cover (processed URL)
  screenshots String[] // IGDB: screenshots (processed URLs)

  // Rating & Metadata
  totalRating           Float? // IGDB: total_rating (0-100)
  totalRatingCount      Int? // IGDB: total_rating_count
  aggregatedRating      Float? // IGDB: aggregated_rating (critic scores)
  aggregatedRatingCount Int? // IGDB: aggregated_rating_count

  // Categories & Classification
  genres    String[] // IGDB: genres (names)
  themes    String[] // IGDB: themes (names)
  gameModes String[] // IGDB: game_modes (names)
  keywords  String[] // IGDB: keywords (names)

  // Companies & Development
  developers String[] // IGDB: involved_companies (developers)
  publishers String[] // IGDB: involved_companies (publishers)

  // External References
  websites      Json? // IGDB: websites (structured data)
  externalGames Json? // IGDB: external_games (Steam, Epic etc.)

  // Age Ratings
  ageRatings Json? // IGDB: age_ratings (structured PEGI, ESRB etc.)

  // System Fields
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastSyncedAt DateTime? // Wann zuletzt von IGDB synchronisiert

  // Legacy Fields (deprecated, f√ºr Migration)
  title       String? // DEPRECATED: use name
  description String? // DEPRECATED: use summary
  developer   String? // DEPRECATED: use developers
  publisher   String? // DEPRECATED: use publishers
  releaseDate DateTime? // DEPRECATED: use firstReleaseDate
  rating      Float? // DEPRECATED: use totalRating
  steamAppId  String? // Legacy Steam App ID

  // Relations
  deals         Deal[]
  platformGames PlatformGame[]
  userGames     UserGame[]
  wishlistedBy  Wishlist[]

  @@map("games")
}

model Platform {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  slug          String         @unique
  iconUrl       String?
  siteUrl       String?
  platformGames PlatformGame[]

  @@map("platforms")
}

model PlatformGame {
  id                 Int      @id @default(autoincrement())
  gameId             Int
  platformId         Int
  platformSpecificId String
  url                String?
  deals              Deal[]
  game               Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platform           Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@unique([gameId, platformId])
  @@unique([platformId, platformSpecificId])
  @@unique([gameId, platformId], map: "platform_games_gameid_platformid_unique")
  @@unique([platformId, platformSpecificId], map: "platform_games_platformid_platformspecificid_unique")
  @@map("platform_games")
}

model UserGame {
  id              Int       @id @default(autoincrement())
  userId          Int
  gameId          Int
  addedAt         DateTime  @default(now())
  playtimeMinutes Int?      @default(0)
  lastPlayed      DateTime?
  isInstalled     Boolean   @default(false)
  isFavorite      Boolean   @default(false)
  notes           String?
  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "user_games_userid_gameid_unique")
  @@map("user_games")
}

model Deal {
  id              Int           @id @default(autoincrement())
  gameId          Int
  platformGameId  Int?
  title           String
  storeName       String
  price           Float?
  discountPercent Float?
  originalPrice   Float?
  url             String
  validFrom       DateTime?
  validUntil      DateTime?
  isFreebie       Boolean       @default(false)
  discoveredAt    DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  externalId      String?
  source          String?
  game            Game          @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platformGame    PlatformGame? @relation(fields: [platformGameId], references: [id])

  @@map("deals")
}

model Achievement {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  description      String
  iconUrl          String?
  criteria         String
  xpReward         Int               @default(0)
  creditsReward    Int               @default(0)
  createdAt        DateTime          @default(now())
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        Int
  achievementId Int
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@unique([userId, achievementId], map: "user_achievements_userid_achievementid_unique")
  @@map("user_achievements")
}

model Wishlist {
  id      Int      @id @default(autoincrement())
  userId  Int
  gameId  Int
  addedAt DateTime @default(now())
  game    Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@unique([userId, gameId], map: "wishlist_items_userid_gameid_unique")
  @@map("wishlist_items")
}
